openapi: 3.0.0
info:
  title: Discovery Service
  version: 1.0.0
  description: Lightning node backend discovery and management service
servers:
  - url: http://localhost:3001
security:
  - bearerAuth: []
paths:
  /discovery:
    post:
      summary: Register new backend
      description: Registers a new Lightning node backend with its connection details and load balancing configuration.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiscoveryBackend'
      responses:
        '201':
          description: Backend created
          headers:
            Location:
              schema:
                type: string
        '409':
          description: Backend already exists

    get:
      summary: Get all backends
      description: Retrieves a list of all registered Lightning node backends.
      parameters:
        - name: If-None-Match
          in: header
          required: false
          description: ETag value from a previous response. If it matches the current ETag, returns 304 Not Modified.
          schema:
            type: string
          example: "12345"
      responses:
        '200':
          description: List of backends
          headers:
            Cache-Control:
              schema:
                type: string
                example: "no-store, no-cache, must-revalidate"
            Expires:
              schema:
                type: string
                example: "Thu, 01 Jan 1970 00:00:00 GMT"
            Pragma:
              schema:
                type: string
                example: "no-cache"
            ETag:
              schema:
                type: string
              description: Current version of the backend list
              example: "12345"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DiscoveryBackendRest'
        '304':
          description: Not Modified - backend list hasn't changed since the ETag provided in If-None-Match
          headers:
            Cache-Control:
              schema:
                type: string
                example: "no-store, no-cache, must-revalidate"
            Expires:
              schema:
                type: string
                example: "Thu, 01 Jan 1970 00:00:00 GMT"
            Pragma:
              schema:
                type: string
                example: "no-cache"
            ETag:
              schema:
                type: string
              description: Current version of the backend list (same as the If-None-Match value)
              example: "12345"
  /discovery/{addr_variant}/{addr_value}:
    get:
      summary: Get specific backend
      description: Retrieves detailed information about a specific Lightning node backend identified by its address.
      parameters:
        - name: addr_variant
          in: path
          required: true
          schema:
            type: string
            enum: [pk, url]
        - name: addr_value
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Backend details
          headers:
            Cache-Control:
              schema:
                type: string
                example: "no-store, no-cache, must-revalidate"
            Expires:
              schema:
                type: string
                example: "Thu, 01 Jan 1970 00:00:00 GMT"
            Pragma:
              schema:
                type: string
                example: "no-cache"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscoveryBackendRest'
        '404':
          description: Backend not found
    put:
      summary: Create or update backend
      description: Creates a new backend or updates an existing one with the provided configuration at the specified address.
      parameters:
        - name: addr_variant
          in: path
          required: true
          schema:
            type: string
            enum: [pk, url]
        - name: addr_value
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiscoveryBackendSparse'
      responses:
        '201':
          description: Backend created
        '204':
          description: Backend updated
    patch:
      summary: Partially update backend
      description: Updates specific fields of an existing Lightning node backend without requiring the full backend configuration.
      parameters:
        - name: addr_variant
          in: path
          required: true
          schema:
            type: string
            enum: [pk, url]
        - name: addr_value
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiscoveryBackendPatchSparse'
      responses:
        '204':
          description: Backend updated
        '404':
          description: Backend not found
    delete:
      summary: Remove backend
      description: Removes a Lightning node backend from the discovery service, preventing it from receiving new traffic.
      parameters:
        - name: addr_variant
          in: path
          required: true
          schema:
            type: string
            enum: [pk, url]
        - name: addr_value
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Backend removed
        '404':
          description: Backend not found
  /health:
    get:
      summary: Health check
      description: Returns HTTP 200 OK to indicate the discovery service is running and accessible.
      security: []
      responses:
        '200':
          description: Service healthy
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    DiscoveryBackend:
      type: object
      required:
        - address
        - partitions
        - weight
        - enabled
        - implementation
      properties:
        address:
          oneOf:
            - type: object
              required:
                - publicKey
              properties:
                publicKey:
                  type: string
                  description: Lightning node public key
            - type: object
              required:
                - url
              properties:
                url:
                  type: string
                  format: uri
                  description: Backend URL
        name:
          type: string
          nullable: true
          description: Optional human-readable name for the backend
        partitions:
          type: array
          items:
            type: string
          description: Load balancing partitions
        weight:
          type: integer
          minimum: 0
          description: Load balancing weight
        enabled:
          type: boolean
          description: Whether the backend is enabled
        implementation:
          $ref: '#/components/schemas/DiscoveryBackendImplementation'

    DiscoveryBackendRest:
      type: object
      description: Backend response with location information
      required:
        - location
        - address
        - partitions
        - weight
        - enabled
        - implementation
      properties:
        location:
          type: string
          description: Resource location path
          example: "url/aHR0cHM6Ly8xOTIuMTY4LjEuMTo4MDgwLw"
        address:
          oneOf:
            - type: object
              required:
                - publicKey
              properties:
                publicKey:
                  type: string
                  description: Lightning node public key
            - type: object
              required:
                - url
              properties:
                url:
                  type: string
                  format: uri
                  description: Backend URL
        name:
          type: string
          nullable: true
          description: Optional human-readable name for the backend
        partitions:
          type: array
          items:
            type: string
          description: Load balancing partitions
        weight:
          type: integer
          minimum: 0
          description: Load balancing weight
        enabled:
          type: boolean
          description: Whether the backend is enabled
        implementation:
          $ref: '#/components/schemas/DiscoveryBackendImplementation'

    DiscoveryBackendSparse:
      type: object
      description: Backend configuration without address (used in PUT requests where address is in path)
      required:
        - partitions
        - weight
        - enabled
        - implementation
      properties:
        name:
          type: string
          nullable: true
          description: Optional human-readable name for the backend
        partitions:
          type: array
          items:
            type: string
          description: Load balancing partitions
        weight:
          type: integer
          minimum: 0
          description: Load balancing weight
        enabled:
          type: boolean
          description: Whether the backend is enabled
        implementation:
          $ref: '#/components/schemas/DiscoveryBackendImplementation'
          
    DiscoveryBackendPatchSparse:
      type: object
      description: Partial update payload for backend configuration without address (used in PATCH requests where address is in path). All fields are optional.
      properties:
        name:
          type: string
          nullable: true
          description: Optional name for the backend
        partitions:
          type: array
          items:
            type: string
          description: Load balancing partitions
        weight:
          type: integer
          minimum: 0
          description: Load balancing weight
        enabled:
          type: boolean
          description: Whether the backend is enabled

    DiscoveryBackendImplementation:
      oneOf:
        - $ref: '#/components/schemas/ClnGrpcImplementation'
        - $ref: '#/components/schemas/LndGrpcImplementation'
        - $ref: '#/components/schemas/RemoteHttpImplementation'
      discriminator:
        propertyName: type
        mapping:
          clnGrpc: '#/components/schemas/ClnGrpcImplementation'
          lndGrpc: '#/components/schemas/LndGrpcImplementation'
          remoteHttp: '#/components/schemas/RemoteHttpImplementation'

    ClnGrpcImplementation:
      type: object
      description: Core Lightning gRPC backend implementation
      required:
        - type
        - url
        - auth
      properties:
        type:
          type: string
          enum: [clnGrpc]
        url:
          type: string
          format: uri
          description: gRPC endpoint URL
        domain:
          type: string
          nullable: true
          description: Optional SNI domain for TLS verification
        auth:
          $ref: '#/components/schemas/ClnGrpcClientAuth'

    ClnGrpcClientAuth:
      type: object
      description: Authentication configuration for CLN gRPC
      required:
        - type
        - caCertPath
        - clientCertPath
        - clientKeyPath
      properties:
        type:
          type: string
          enum: [path]
        caCertPath:
          type: string
          description: Path to CA certificate file
        clientCertPath:
          type: string
          description: Path to client certificate file
        clientKeyPath:
          type: string
          description: Path to client key file

    LndGrpcImplementation:
      type: object
      description: LND gRPC backend implementation
      required:
        - type
        - url
        - auth
        - ampInvoice
      properties:
        type:
          type: string
          enum: [lndGrpc]
        url:
          type: string
          format: uri
          description: gRPC endpoint URL
        domain:
          type: string
          nullable: true
          description: Optional SNI domain for TLS verification
        auth:
          $ref: '#/components/schemas/LndGrpcClientAuth'
        ampInvoice:
          type: boolean
          description: Whether to use AMP invoices

    LndGrpcClientAuth:
      type: object
      description: Authentication configuration for LND gRPC
      required:
        - type
        - tlsCertPath
        - macaroonPath
      properties:
        type:
          type: string
          enum: [path]
        tlsCertPath:
          type: string
          description: Path to TLS certificate file
        macaroonPath:
          type: string
          description: Path to macaroon file

    RemoteHttpImplementation:
      type: object
      description: Remote HTTP backend implementation
      required:
        - type
      properties:
        type:
          type: string
          enum: [remoteHttp]